## CWE-434: Unrestricted Upload of File with Dangerous Type
- https://cwe.mitre.org/data/definitions/434.html

---
## Descrição

*Unrestricted Upload of File with Dangerous Type* é uma vulnerabilidade que surge em aplicações que carecem de mecanismos de verificação do tipo de ficheiros submetidos, podendo estes ser maliciosos.

Relativamente à aplicação desenvolvida, na página *Reserved Area* e na aba *Upload Test Results*, não é verificado o tipo do ficheiro enviado pelo utilizador. Sendo assim, caso um atacante faça upload de ficheiros maliciosos, estes podem não comprometer diretamente o sistema, mas certamente representarão uma ameaça para o utilizador final.


**Código exemplo**:
```python
if request.method == "POST":
    patient_email = request.form['patient_email']
    file_ = request.files['results_file']
    # MISSING -> Verify file type
    ...
```

---
## Explorar a vulnerabilidade

A forma mais simples de explorar esta vulnerabilidade consiste apenas em submeter um ficheiro malicioso como resultado de um teste. Assim, quando o utilizador o descarregar, caso não esteja munido com um antivírus, verá a segurança da sua máquina comprometida.

# TODO -> Mostrar screenshots

---
## Solução

A abordagem mais intuitiva para evitar esta vulnerabilidade consiste em proceder à verificação do tipo do ficheiro submetido.
Embora não impeça totalmente a exploração da vulnerabilidade, é possível limitar o tipo de ficheiros que podem ser enviados, para ficheiros com extensão `.pdf`, por exemplo.

Código exemplo:
```python
if request.method == "POST":
    patient_email = request.form['patient_email']
    file_ = request.files['results_file']
    if file_.content_type != 'application/pdf':
        return render_template("reserved_area.html", error="File type is not supported")
```