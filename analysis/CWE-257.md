## CWE-257: Storing Passwords in a Recoverable Format
- https://cwe.mitre.org/data/definitions/257.html

---
## Descrição
*Storing Passwords in a Recoverable Format*, como o próprio nome sugere, é uma vulnerabilidade que permite que as passwords sejam armazenadas em formatos recuperáveis (*plain text*, por exemplo). Desse modo, podem ser facilmente obtidas por um eventual atacante.

Na nossa aplicação insegura, esta vulnerabilidade está presente no registo de novos utilizadores, já que a password é armazenada em *plain text*.

Codigo exemplo:
```python
conn = sqlite3.connect('db.sqlite3')
cur = conn.cursor()
if request.method == "POST":
    # Missing password hashing and salting
    cur.executescript(
        f"INSERT INTO app_user (email, password_, name_) VALUES ('{email}', '{password}', '{full_name}');"
    )
```

---
## Explorar a vulnerabilidade
Esta vulnerabilidade pode ser explorada, tendo por base outras como, por exemplo, a do SQL Injection [CWE-89](CWE-89.md).

Na página *Doctor*, conseguimos apresentar os diferentes campos da tabela do utilizador, incluindo a password, se inserirmos na caixa de pesquisa: 
```sql
1' AND 1=2 UNION SELECT name_, email, password_ FROM app_user -- //
```
# TODO -> Mostrar screenshots

---
## Solução
Para evitar este tipo de vulnerabilidade, com potencial para comprometer a intregridade do sistema, todas as passwords devem ser alvo de um processo de *hashing*.
Um *hash* deve ser imprevisível e único, de forma a que não seja possível descobrir a password original.

Na versão segura da aplicação, recorremos ao módulo ```Flask-Bcrypt```, que disponibiliza uma *hash function* e um método de verificação de password.

Codigo exemplo:
```python
conn = sqlite3.connect('db.sqlite3')
cur = conn.cursor()
if request.method == "POST":
    password_hash = Bcrypt().generate_password_hash(password).decode('utf-8')
    cur.execute(
        "INSERT INTO app_user (email, password_, name_) \
            VALUES (? ,?, ?);", (email, password_hash, full_name)
    )
```