## CWE-257: Storing Passwords in a Recoverable Format
- https://cwe.mitre.org/data/definitions/257.html

---
## Descrição
*Storing Passwords in a Recoverable Format*, como o próprio nome sugere, é uma vulnerabilidade que permite que as passwords sejam armazenadas em formatos recuperáveis (*plain text*, por exemplo). Desse modo, podem ser facilmente obtidas por um eventual atacante.

Na nossa aplicação insegura, esta vulnerabilidade está presente no registo de novos utilizadores, já que a password é armazenada em *plain text*.

Codigo exemplo:
```python
conn = sqlite3.connect('db.sqlite3')
cur = conn.cursor()
if request.method == "POST":
    # Missing password hashing and salting
    cur.executescript(
        f"INSERT INTO app_user (email, password_, name_) VALUES ('{email}', '{password}', '{full_name}');"
    )
```

---
## Explorar a vulnerabilidade
Como referido anteriormente, esta vulnerabilidade pode ser explorada tendo por base outras vulnerabilidades já existentes, como por exemplo SQL Injection [CWE-89](CWE-89.md).

Na página "doctors", ao inserirmos no formulário de pesquisa o seguinte parâmetro de pesquisa:

```sql
1' AND 1=2 UNION SELECT name_, email, password_ FROM app_user -- //
```

os diferentes campos da tabela relativa aos utilizadores irão ser apresentados. Como as password foram armazenadas em plain text, com este ataque estas serão totalmente visíveis.


# TODO -> Mostrar screenshots

---
## Solução
Para evitar este tipo de vulnerabilidade, que por sua vez pode prejudicar a segurança e intregridade do sistema, todas as passwords que necessitam de ser armazenadas, devem ser alvo de um processo de hashing. Assim, mesmo que seja possível o acesso a informação sensível, esta acaba por ser inútil.

Na versão segura da aplicação recorremos ao módulo <code>Flask-Bcrypt</code>. Este módulo disponibiliza diversos métodos, sendo um deles a conversão de password para hash e verificação entre uma dada password e um hash, sendo este último utilizado no processo de login.

Codigo exemplo:
```python
conn = sqlite3.connect('db.sqlite3')
cur = conn.cursor()
if request.method == "POST":
    password_hash = Bcrypt().generate_password_hash(password).decode('utf-8')
    cur.execute(
        "INSERT INTO app_user (email, password_, name_) \
            VALUES (? ,?, ?);", (email, password_hash, full_name)
    )
```